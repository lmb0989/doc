<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.59" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="icon" href="/logo.png"><title>技术笔记</title><meta name="description" content="">
    <link rel="preload" href="/assets/style-CxVbFQEd.css" as="style"><link rel="stylesheet" href="/assets/style-CxVbFQEd.css">
    <link rel="modulepreload" href="/assets/app-DJCjgs7r.js"><link rel="modulepreload" href="/assets/如何重绘「江南百景图」.html-CkA78Iud.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/" aria-label="带我回家"><img class="vp-nav-logo" src="/logo.png" alt><!----><span class="vp-site-name hide-in-pad">技术笔记</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><!----><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Git</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">JavaScript</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Jenkins</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Linux</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">NodeJS</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">PS插件开发</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Python</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">TypeScript</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">doc</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">其他</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">加密技术</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">工具</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">数据库</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">构建工具</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">正则表达式</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">游戏</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">CocosCreator</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/Book/%E6%B8%B8%E6%88%8F/CocosCreator/Android%20%E5%8D%87%E7%BA%A7%20Gradle.html" aria-label="Android 升级 Gradle"><!---->Android 升级 Gradle<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Bug收集</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/Book/%E6%B8%B8%E6%88%8F/CocosCreator/" aria-label="index"><!---->index<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">shader</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/Book/%E6%B8%B8%E6%88%8F/CocosCreator/shader.html" aria-label="shader"><!---->shader<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/Book/%E6%B8%B8%E6%88%8F/CocosCreator/%E5%A6%82%E4%BD%95%E9%87%8D%E7%BB%98%E3%80%8C%E6%B1%9F%E5%8D%97%E7%99%BE%E6%99%AF%E5%9B%BE%E3%80%8D.html" aria-label="如何重绘「江南百景图」"><!---->如何重绘「江南百景图」<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">定制引擎</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/Book/%E6%B8%B8%E6%88%8F/CocosCreator/%E5%AE%9E%E7%8E%B0%E6%B5%8F%E8%A7%88%E5%99%A8%E7%AB%AF%E5%86%99%E6%96%87%E4%BB%B6.html" aria-label="实现浏览器端写文件"><!---->实现浏览器端写文件<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">帧同步</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">性能优化</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/Book/%E6%B8%B8%E6%88%8F/CocosCreator/%E6%B7%B1%E5%B1%82%E8%A7%A3%E8%AF%BB.html" aria-label="深层解读"><!---->深层解读<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">微信小游戏</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/Book/%E6%B8%B8%E6%88%8F/%E6%B6%88%E7%81%AD%E6%95%8C%E4%BA%BA.html" aria-label="消灭敌人"><!---->消灭敌人<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">游戏推荐</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">腾讯云开发</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">网络</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">部署集成</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!----></h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2024年12月3日</span><meta property="datePublished" content="2024-12-03T08:56:20.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 32 分钟</span><meta property="timeRequired" content="PT32M"></span><!----><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc" vp-toc><!----><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#转换-or-重写">转换 or 重写</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#渲染优化">渲染优化</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#合批">合批</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#动态合图">动态合图</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#采用同一个材质资源">采用同一个材质资源</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#优化-shader-的输入数据">优化 Shader 的输入数据</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#层级规划">层级规划</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ui-渲染优化">UI 渲染优化</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#自定义引擎">自定义引擎</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#增强-tiledmap">增强 TiledMap</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#将道路转为-tile">将道路转为 Tile</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#资源压缩">资源压缩</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#图片缩放">图片缩放</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#图片减色">图片减色</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#场景剔除">场景剔除</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#寻路">寻路</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#再谈性能">再谈性能</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#模糊特效">模糊特效</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#rendertexture-池">RenderTexture 池</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#点击检测">点击检测</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#数组排序">数组排序</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#其他优化">其他优化</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#「阅后即焚」">「阅后即焚」</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#构建优化">构建优化</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#结语">结语</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content" vp-content><p>去年，古风模拟经营类手游《江南百景图》成功破圈，成为年度现象级爆款。 <strong>如何将它搬到小游戏平台？是转换还是重写？使用哪些技术方案，能在包体大小仅为原版 1/20 的同时，达到与 App 版相当的游戏体验？</strong> 椰岛小游戏研发负责人 <strong>大城小胖</strong> ，带着他近 300 页的 PPT，在 Cocos 的两次线下活动中做了全面的技术分享。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/9/8/9883303807d49355ff8a6dd7d2aaa2f49a2fefe7.png" target="_blank" rel="noopener noreferrer"><img src="/assets/9883303807d49355ff8a6dd7d2aaa2f49a2fefe7_2_690x459-CnbN4Kbc.png" alt="game" loading="lazy">game1080×720 838 KB</a></p><h2 id="转换-or-重写" tabindex="-1"><a class="header-anchor" href="#转换-or-重写"><span>转换 or 重写</span></a></h2><p>《江南百景图》App 版游戏包大小有 <strong>600+M</strong> ，上线前期还有部分用户反映游戏运行时手机发热严重。而小游戏版在经过立项选型后，决定使用 <strong>Cocos Creator</strong> 重写，仅用了 1 天就做出了 Demo。经过 4 个月的优化，我们最后将包体压缩到 <strong>30M</strong> 左右，同时保证游戏体验与 App 版相当。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/f/2/f2bfc91809d669dadfeb16e796cec5c89d25f83c.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/f2bfc91809d669dadfeb16e796cec5c89d25f83c_2_690x387-stM195UP.jpeg" alt="B095A344-0AB8-4ACF-94BA-013CA3E08EE1" loading="lazy">B095A344-0AB8-4ACF-94BA-013CA3E08EE11352×760 243 KB</a></p><p>优化的过程中，我们做了以下工作，其中 代码 部分需要重新设计和编写。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/5/3/53aab9f244d81a91e1b51ff39e8dcaa13fba467b.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/53aab9f244d81a91e1b51ff39e8dcaa13fba467b_2_690x317-C4hB8_xu.jpeg" alt="WeChat53065d81487f52e0255e074c84201dc3" loading="lazy">WeChat53065d81487f52e0255e074c84201dc31000×460 60.2 KB</a></p><h2 id="渲染优化" tabindex="-1"><a class="header-anchor" href="#渲染优化"><span>渲染优化</span></a></h2><p>原生版本的《江南百景图》移植到小游戏首先需要解决的就是 <strong>耗电高、易发烫、Draw Call 高</strong> 等问题。</p><h3 id="合批" tabindex="-1"><a class="header-anchor" href="#合批"><span>合批</span></a></h3><p>合批是降低 Draw Call 最快也是最有效的方式。优化同样的 Texture，将多张的图片合并到一张图集上，这样不论要生成多少张不同的图片，都不会打断合批渲染，Draw Call 也就降低下来了。</p><p>但是《江南百景图》的资源非常多，每个玩家使用资源的顺序也不尽相同，如果玩家使用的资源分别在不同的图集上，还是会导致合批渲染被打断，产生 Draw Call。因此，针对这一情况，我们采用了 <strong>Multi-Texture</strong> 的方式进行了优化，其原理是将传统的判断是否在同一张图集，转换为判断是否在 <strong>同一批图集</strong>，这样就大大减少了 Draw Call 产生。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/0/b/0b02e9c4bdfd13e7fd07b60379cc7136e6c41e84.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/0b02e9c4bdfd13e7fd07b60379cc7136e6c41e84_2_690x387-aKZ4Up0x.jpeg" alt="WeChatfcf178e3cfb6af9dc743dd61503c0a0f" loading="lazy">WeChatfcf178e3cfb6af9dc743dd61503c0a0f1000×562 123 KB</a></p><p>另外，通过 gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS) 这个指令，可以知道在一台设备中 Shader 最多支持几张图集。测试发现目前 90% 以上的手机至少支持8张，因此我们将批图集的数量设置为8张。因为一个批次有 8 张图集，所以我们是通过这个 idx 判断某张图用的哪个图集，代码也很简单。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/8/8/88bdcf1f9172895d4c831523cdce9f6a662543e5.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/88bdcf1f9172895d4c831523cdce9f6a662543e5_2_690x381-shul5hMn.jpeg" alt="drawcall" loading="lazy">drawcall1052×582 129 KB</a></p><h3 id="动态合图" tabindex="-1"><a class="header-anchor" href="#动态合图"><span>动态合图</span></a></h3><p>小游戏版本采用了 Cocos 的动态合图机制，这样在 CDN 下载的图片也能进行合图。而为了提高合图的效率，避免浪费空间，我们会将长度或者宽度特别大的图片进行裁剪。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/b/4/b446cecc364dfeea8d93a43883e10306d3e8e47b.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/b446cecc364dfeea8d93a43883e10306d3e8e47b_2_690x319-DEqyjJFw.jpeg" alt="all0" loading="lazy">all01438×666 311 KB</a></p><p>例如左图中的旗杆，由于图片太长，在动态合图时会导致空间浪费，因此我们将这张旗杆的图片裁剪成两张，如右图所示，再在项目中进行拼接处理。</p><h3 id="采用同一个材质资源" tabindex="-1"><a class="header-anchor" href="#采用同一个材质资源"><span>采用同一个材质资源</span></a></h3><p>在《江南百景图》中，玩家移动地图时，原本在显示范围外的图片将从水墨色变为彩色。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/e/9/e9e61ec6f1fb8d99cfaac1dccebdc7ded886f4f7.gif" target="_blank" rel="noopener noreferrer"><img src="/assets/e9e61ec6f1fb8d99cfaac1dccebdc7ded886f4f7_2_295x500-zE6tNbCr.gif" alt="__3" loading="lazy">__3350×592 1.71 MB</a></p><p>传统的方案是改变图片材质，当地图移动到要显示的节点时，节点一个一个地进行材质的切换，达到一个 “淡入淡出” 的效果。但是在项目中尝试之后，我们发现这样会导致 Draw Call 上升，而且拖拽地图又是一个很频繁的操作，游戏中实际效果较差。</p><p>因此在这里我们将所有城市物体资源，无论是人物还是建筑、常态还是淡入状态，都用统一的 Material、并使用顶点数据传递“时间参数”，以此节约性能消耗，最终达到所有建筑和人物的创建、移动、销毁等全都只需要一个材质就能够完成。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/4/1/416e46414a4d15eae7ac81a72c01edac69690d1e.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/416e46414a4d15eae7ac81a72c01edac69690d1e_2_690x386-CfnLiC9K.jpeg" alt="material" loading="lazy">material1358×760 157 KB</a></p><p>很多人会觉得一个普通的图片也用这么复杂的方案，会影响性能，导致性能变差。但是实际测试效果并不差，这也告诉我们，在游戏开发中还是要以实践为准，不能想当然。</p><h3 id="优化-shader-的输入数据" tabindex="-1"><a class="header-anchor" href="#优化-shader-的输入数据"><span>优化 Shader 的输入数据</span></a></h3><p>由于《江南百景图》的图片资源中不会用到 Color 这个属性，因此在材质中，我们将原有的 Color 数据去除掉。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/4/4/444c32fc675866f9ce63e0f191ad468e88d82fee.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/444c32fc675866f9ce63e0f191ad468e88d82fee_2_690x253-BHRpWJER.jpeg" alt="nodeColor" loading="lazy">nodeColor1360×500 78.3 KB</a></p><p>下图是一个正常的顶点数据：</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/7/d/7d4e0447ab4b4645e570003873dd8896cea7dcee.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/7d4e0447ab4b4645e570003873dd8896cea7dcee_2_690x152-5YxIAwnG.jpeg" alt="vertex" loading="lazy">vertex2256×498 234 KB</a></p><p>接下来就是将原有的 Color 数据去除掉。用来存放项目中所需要的其它信息，这样做可以减少 CPU 与 GPU 互相传输的数据量。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/0/e/0e1827996c8dbaf1132e7078c1c7db4eecb0963f.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/0e1827996c8dbaf1132e7078c1c7db4eecb0963f_2_690x250-CAUAqJRz.jpeg" alt="scaleVague" loading="lazy">scaleVague1840×668 240 KB</a></p><h3 id="层级规划" tabindex="-1"><a class="header-anchor" href="#层级规划"><span>层级规划</span></a></h3><p>我们将不同的类型的资源，分别放置在对应的层级中。《江南百景图》共分了13个层级，下图只展示了部分比较重要的层级：</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/5/1/51d6e795bb268ea8d541c757ac4cc5e515d4f37f.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/51d6e795bb268ea8d541c757ac4cc5e515d4f37f_2_690x385-Dwd1Bjpd.jpeg" alt="hierarchy" loading="lazy">hierarchy1360×760 84 KB</a></p><p>其中比较有意思的是 <strong>旗帜层</strong> 。旗帜是《江南百景图》中的一个常见元素，但因为项目实际技术限制，无法将一个旗帜制作在一个完整龙骨动画中，如果强行放在一起，就会导致在渲染到旗帜的时候出现断批。我们采用了 <strong>动态组织层级关系</strong> 的方式来解决这个问题。例如这是一个原来的旗帜预制体：</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/9/6/96db2b554c83da8000fcf3fc1d32b5bf39584bec.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/96db2b554c83da8000fcf3fc1d32b5bf39584bec_2_690x385-TFxVD9EL.jpeg" alt="flag" loading="lazy">flag1358×758 139 KB</a></p><p>采用 <strong>动态组织层级关系</strong> 的方式，将旗杆与旗面拆开，旗杆放在下面的普通建筑物层，旗面则单独分为一层旗帜层放在上层，这样就很好地避免了渲染时一直被打断合批的情况。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/7/3/73357d7754a9edb6b962b63ff7be05f28a54a6a2.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/73357d7754a9edb6b962b63ff7be05f28a54a6a2_2_690x386-Dz9dSj1N.jpeg" alt="changeFlag" loading="lazy">changeFlag1358×760 148 KB</a></p><h3 id="ui-渲染优化" tabindex="-1"><a class="header-anchor" href="#ui-渲染优化"><span>UI 渲染优化</span></a></h3><p>UI 部分我们没有使用动态合图或者 MultiTexture，动态合图我们留给了游戏中的人物和建筑、而没有使用 MultiTexture 主要是开发成本的原因。但在我们的优化下，现在游戏的 Draw Call 可以降得很低。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/b/9/b919b3fe7a5a3efc2e9e3e2c0a1b23eecdd16058.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/b919b3fe7a5a3efc2e9e3e2c0a1b23eecdd16058_2_690x384-B2XAVnOE.jpeg" alt="UIShader" loading="lazy">UIShader1360×758 85.4 KB</a></p><p>UI 方面我们也是做了分层，比如下面左边的图上我们的 button 层，里面都是按钮部分，右边是我们的标签牌层级。这样我们就可以根据功能区去划分图集，然后和游戏里的层级对应起来，而不会打断合批。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/4/5/45e15b10834e01180dca1cd5ba91ae83c9c5f03c.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/45e15b10834e01180dca1cd5ba91ae83c9c5f03c_2_690x388-Bhg-wEMX.jpeg" alt="Layered" loading="lazy">Layered2130×1198 305 KB</a></p><h2 id="自定义引擎" tabindex="-1"><a class="header-anchor" href="#自定义引擎"><span>自定义引擎</span></a></h2><p>Cocos 是个开源引擎，我们可以根据项目的实际需要，对引擎进行定制、修改，从而达到更好的效果。</p><h3 id="增强-tiledmap" tabindex="-1"><a class="header-anchor" href="#增强-tiledmap"><span>增强 TiledMap</span></a></h3><p>我们在 Cocos Creator 原有的 TiledMap 组件的基础上，拓展了新的功能，下图是 Cocos 自带的组件。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/1/a/1ac039278ceb8147895fce5d9233c155933a48d1.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/1ac039278ceb8147895fce5d9233c155933a48d1_2_690x139-vTutethQ.jpeg" alt="tiledmap" loading="lazy">tiledmap2262×456 69.2 KB</a></p><p>这里就不详细说了，有兴趣的可以去官方文档查阅，我们主要来说一下经过拓展的新功能。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/7/8/78d6e6874ac20ca36c91fa423f2239e2bca130c8.png" target="_blank" rel="noopener noreferrer"><img src="/assets/78d6e6874ac20ca36c91fa423f2239e2bca130c8_2_690x231-DzcLUw7b.png" alt="tiledmap2" loading="lazy">tiledmap21178×396 90.5 KB</a></p><p><strong>1. Diamond Tile：</strong> 游戏中使用了很多 TiledMap 中的图块菱形方块， 但是引擎默认的传递方式是矩形，这样就会造成数据浪费和冗余。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/6/5/652ca553ed4da04afc760cc879eeacbf9f117a41.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/652ca553ed4da04afc760cc879eeacbf9f117a41_2_690x346-CeZx5Exe.jpeg" alt="tiledmap3" loading="lazy">tiledmap3934×469 167 KB</a></p><p>这些图片首先都是 <strong>规则的菱形</strong> ，所以很简单，直接 <strong>根据宽高进行进行计算。</strong></p><p><a href="https://forum.cocos.org/uploads/default/original/3X/d/f/df07655bd851f5989e509deaa1b0b15b214e41e0.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/df07655bd851f5989e509deaa1b0b15b214e41e0_2_690x320-C04QVJ6c.jpeg" alt="tiledmap4" loading="lazy">tiledmap41098×510 201 KB</a></p><p>将菱形周围多余的部分切割，这样很明显图片大小减少了一半.这里注意一下非标准图形就不能这么用了。</p><p><strong>2. Share Culling：</strong> 《江南百景图》共有三层 TiledMap 地图层， <strong>勾选时</strong> 将只对 TiledMap 的第一个地图层进行处理判断可视区域的范围，而其他的地图层将直接照搬第一个地图层的处理结果，这样能够节约不少性能。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/a/1/a116b10ce07631408863f7c9315e2ad6fcdb6242.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/a116b10ce07631408863f7c9315e2ad6fcdb6242_2_690x357-fw94Ylua.jpeg" alt="tiledmap5" loading="lazy">tiledmap52434×1262 424 KB</a></p><p><strong>3. With Color：</strong> 如果不需要颜色数据就可以勾选，减少数据量的传输。</p><h3 id="将道路转为-tile" tabindex="-1"><a class="header-anchor" href="#将道路转为-tile"><span>将道路转为 Tile</span></a></h3><p>游戏中的道路是不需要进行淡入淡出效果的，如果当作普通建筑物资源来用之前的材质进行渲染，会消耗相当多的性能。因此我们将道路作为 Tile Map 地图的一部分，让道路不需要用之前提到的材质进行渲染。</p><p>还有一个小细节，在 Tiled Map Editor 中设置的宽高，与实际项目中使用是无关的，因此在生成的时候可以将地图块按照实际项目需求进行缩小，减少资源使用。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/f/9/f9eebd4b483586f731f11eadb8633f041792fd18.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/f9eebd4b483586f731f11eadb8633f041792fd18_2_690x384-BntOf9TO.jpeg" alt="tileSet" loading="lazy">tileSet1360×758 114 KB</a></p><h2 id="资源压缩" tabindex="-1"><a class="header-anchor" href="#资源压缩"><span>资源压缩</span></a></h2><p>将一个原版 600+M 的游戏压缩到最终的 30M 左右，资源的压缩工作必不可少。我们需要将游戏资源进行合理的压缩，使其更加适合小游戏运行，并且不影响游戏最终的显示效果。</p><h3 id="图片缩放" tabindex="-1"><a class="header-anchor" href="#图片缩放"><span>图片缩放</span></a></h3><p>对不同类型、不同清晰度的资源，我们可以设置不同的缩放比例。我们将大部分的建筑缩放到原来的 0.65 倍，背景中的山川则被缩放到原来的 0.3 倍。另外，就算是相同位置上使用的人物立绘，由于每个人物的自身和背景的颜色、精度不同，也都可以给它们设置不同的缩放比例。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/e/e/eedb9fee93991333f882f2a21a383cc2ab909fe0.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/eedb9fee93991333f882f2a21a383cc2ab909fe0_2_690x385-CwqoI_WT.jpeg" alt="smallSpr" loading="lazy">smallSpr1540×861 429 KB</a></p><p>于是我们将所有 Sprite 组件采用 <strong>Custom</strong> 模式，可以自由控制比例。不同的图片使用差异化配置，设置不同的缩放比例，用脚本控制缩放比例，这样便可以打包出任意画质和体积的各种版本，并且还提升了动态合图的利用率和部分性能。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/3/5/35924e503fef6f01afb3d0d7ff5789a7b066a3c7.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/35924e503fef6f01afb3d0d7ff5789a7b066a3c7_2_690x385-CVA2S2Kf.jpeg" alt="custom" loading="lazy">custom1358×758 202 KB</a></p><p><a href="https://forum.cocos.org/uploads/default/original/3X/0/1/0192f906bf946f3ef74213b7ca422f0f95cff574.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/0192f906bf946f3ef74213b7ca422f0f95cff574_2_690x375--XjETLq9.jpeg" alt="scale" loading="lazy">scale1348×734 283 KB</a></p><h3 id="图片减色" tabindex="-1"><a class="header-anchor" href="#图片减色"><span>图片减色</span></a></h3><p>综合比较了大家比较熟知的 tinypng 和 pngquant 两种工具之后，项目最终选择使用 <strong>pngquant</strong> 对 PNG 图片进行批量压缩。pngquant 可以自定义压缩品质，而且 pngquant 开源，容易维护，风险可控。pngquant 也提供像 ImageAlpha 这样的工具，可以实时查看图片减色后的效果，方便调整参数。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/b/9/b97c2d261047898f59c898b462eeb4a3e1ba08a5.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/b97c2d261047898f59c898b462eeb4a3e1ba08a5_2_690x327-erSsDesu.jpeg" alt="pngquant" loading="lazy">pngquant1358×644 66.9 KB</a></p><p>需要注意的是，由于 Cocos 会进行合图处理，如果对 Build 前的图片做压缩，合图时前期的一些压缩工作可能就此无效化，所以我们要对 <strong>Build 后的图片</strong> 做压缩处理。</p><p>另外我们也建议程序多了解一下图片格式以及其原理。不是所有图片都要使用 PNG 格式，也会有使用 JPG 的情况。</p><h2 id="场景剔除" tabindex="-1"><a class="header-anchor" href="#场景剔除"><span>场景剔除</span></a></h2><p>这部分我们的需求是 <strong>只渲染可视物体</strong> 。那么用什么方法确定哪些物体是可见的呢？最开始我们使用了四叉树，但是在 JS 语言中的效果并不好。所以我们给地图划分格子，Grid 的单元格大小要适中，但单元格的边长应为 <strong>2的整次幂</strong> ，便于利用 <strong>位运算</strong> 提升性能。</p><p>如下图所示，红框就是镜头，所以需要渲染的也就是这个红框里出现的格子。然后我们再根据建筑物的坐标、大小去进行计算，判断建筑在哪一行哪一列的格子里，从而确定该建筑物是否是需要被渲染的物体。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/c/e/ce2c592c6d7d5ee09951a360eb25b80a408e2e13.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/ce2c592c6d7d5ee09951a360eb25b80a408e2e13_2_690x379-DHJgHNXO.jpeg" alt="clear" loading="lazy">clear1077×592 443 KB</a></p><p><a href="https://forum.cocos.org/uploads/default/original/3X/b/a/ba11d1e8c208c7b93da3f2a788b942e1025296a5.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/ba11d1e8c208c7b93da3f2a788b942e1025296a5_2_690x387-C_EGbLyJ.jpeg" alt="test" loading="lazy">test1812×1018 283 KB</a></p><p>这是一段简单的检测函数 大家可以根据自己的项目需求去进行扩展。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/c/8/c8581b727739ce77d7f034970b12b916757925b6.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/c8581b727739ce77d7f034970b12b916757925b6_2_690x314-DY0lRm9I.jpeg" alt="testTs" loading="lazy">testTs1786×814 139 KB</a></p><p>除此之外，为了防止特殊情况出现，判断的可视范围需要比实际范围更大一些。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/0/4/041307027f02bc2cbf06483906c8db5ef9b16704.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/041307027f02bc2cbf06483906c8db5ef9b16704_2_690x388-B22Es4HS.jpeg" alt="range" loading="lazy">range1812×1020 184 KB</a></p><h2 id="寻路" tabindex="-1"><a class="header-anchor" href="#寻路"><span>寻路</span></a></h2><p>《江南百景图》使用的寻路算法，有针对单源单点的 <strong>A</strong>* 和单源多点的 <strong>Dijkstra</strong> 。但这里我们要讲的不是寻路算法，而是在游戏中的用法优化。</p><p>针对地图很大、建筑物和人物都很多的情况下，这些算法一起执行就会很损耗性能。所以我们用了 <strong>分时寻路</strong> ，就是把寻路过程由一帧分到若干帧去进行计算，这样就不会在某一个时间段集中进行大量运算，对游戏性能也不会有太大的影响。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/5/7/57a5e095c4b3d385b579b5883fea038ac28e7ed8.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/57a5e095c4b3d385b579b5883fea038ac28e7ed8_2_690x357-BdVLaQGl.jpeg" alt="pathfinding" loading="lazy">pathfinding2040×1056 343 KB</a></p><p>除此之外我们还在游戏里做了一个大胆的优化，就是统一管理寻路任务，同一时间只为一个角色服务。也许有人会问，那岂不是一个角色在哪里走、其他对象都在那边等着？其实真正在游戏里不会有这种奇怪的表现。首先每个角色寻路的起始和结束时间都不一样，再者这个同一时间是非常短的，就等于把角色寻路分配到了不同帧里，交替进行执行。</p><h2 id="再谈性能" tabindex="-1"><a class="header-anchor" href="#再谈性能"><span>再谈性能</span></a></h2><h3 id="模糊特效" tabindex="-1"><a class="header-anchor" href="#模糊特效"><span>模糊特效</span></a></h3><p>玩家在打开《江南百景图》的任意界面时，游戏的背景需要做模糊处理，而背景中的人物动画等仍需要正常播放。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/8/2/82b3320e16f41e3b31728a26788a3084fd74a128.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/82b3320e16f41e3b31728a26788a3084fd74a128_2_690x388-BqIXaeIl.jpeg" alt="vague" loading="lazy">vague1360×766 250 KB</a></p><p>模糊效果我们最常见的就是高斯模糊。高斯模糊的效果很好，但是性能却较为一般。下图是常见的一些模糊算法：</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/3/8/38ca5e09bee396b55d889a07d4d5dc750eddb8ae.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/38ca5e09bee396b55d889a07d4d5dc750eddb8ae_2_690x365-Bl1I6rL9.jpeg" alt="blur" loading="lazy">blur1360×720 211 KB</a></p><p>经过综合的考虑，在江南百景图项目中，最终采用了 <strong>Kawase 模糊</strong>，具有较高的效果的同时又具有较好的性能。关于更多的各种模糊的详细介绍，可以参考 <a href="https://zhuanlan.zhihu.com/p/125744132" target="_blank" rel="noopener noreferrer">十种图像模糊算法的总结</a>。</p><p>下面的是对于传统的高斯模糊与 Kawase 模糊的效果对比：</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/2/7/2755dec0d7ebf82818923e895866d52a41a8e4b2.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/2755dec0d7ebf82818923e895866d52a41a8e4b2-BEWCqMyb.jpeg" alt="blurCompare" loading="lazy">blurCompare780×425 61.4 KB</a></p><p>运用了高斯模糊的的画面很卡大概是每秒 <strong>十几帧</strong> 的样子。而采用了 <strong>Kawase 模糊</strong> 的画面是可以流畅运行的，可以跑满 <strong>60 帧</strong>。</p><p>另外，还有一个可以适配任何模糊算法的方法，可以将要模糊的图片先渲染到一个小的 RenderTexture 上，然后将其 <strong>模糊后再放大</strong> 显示，这样做可以增加模糊算法的 <strong>处理速度</strong>。如下图所示:</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/0/e/0e1827996c8dbaf1132e7078c1c7db4eecb0963f.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/0e1827996c8dbaf1132e7078c1c7db4eecb0963f_2_690x250-CAUAqJRz.jpeg" alt="scaleVague" loading="lazy">scaleVague1840×668 240 KB</a></p><h3 id="rendertexture-池" tabindex="-1"><a class="header-anchor" href="#rendertexture-池"><span>RenderTexture 池</span></a></h3><p>在小游戏或 Web 端 <strong>创建 RenderTexture</strong> 时，比较损耗性能。所以我们在游戏中使用完 RenderTexture 后，不是直接销毁，而是将其放在一个 <strong>缓存池</strong> 中，下次从缓存池中调用符合要求的 RenderTexture 即可。</p><h3 id="点击检测" tabindex="-1"><a class="header-anchor" href="#点击检测"><span>点击检测</span></a></h3><p>《江南百景图》中有很多建筑物，而在用户点击时，并非简单地通过地形上的块做判断，而是给每个建筑物画了一个 <strong>多边形检测区域</strong> 。但是建筑物是移动的，如果 <strong>多边形检测区域</strong> 也随之移动，从性能和逻辑上都不是好的处理方式。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/4/7/4709dad4d7e0fe59d6045f1ad58a307bc3d78dfc.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/4709dad4d7e0fe59d6045f1ad58a307bc3d78dfc_2_690x385-DOFRyiYe.jpeg" alt="click" loading="lazy">click1910×1066 234 KB</a></p><p>于是在实际操作中，我们让建筑物移动，而对应的 <strong>多边形检测区域</strong> 不做移动，并将其设置在原点坐标上。用户点击操作时，将点击的坐标减去建筑物相对原点的坐标，就可以进行点击检测了。同理如果建筑物是反转状态，可以将点击坐标进行镜像，而 <strong>多边形检测区域</strong> 仍然可以不做调整。类似还有其他情况，大家也可以去了解一下各情况下对多边形的处理方式。</p><h3 id="数组排序" tabindex="-1"><a class="header-anchor" href="#数组排序"><span>数组排序</span></a></h3><p>数组排序是大家容易忽略的一个优化模块，很多开发者在开发中都直接使用 <strong>Array.sort()</strong> 这样的 <strong>快速排序</strong> 算法，但是其实每种排序算法其实他都有一个擅长的场景。在开发中应该针对实际的项目情况采用合适的排序算法。例如 <strong>Array.sort()</strong> 排序更适用于混乱无章的数据，而在江南百景图项目中 <strong>每一帧</strong> 都会对这些人物建筑物进行排序，而这一帧对于上一帧来说差异不会很大，也就是相对 <strong>有序的数据</strong>。因此，它更适合使用像下图这样的 <strong>插入排序</strong> 算法。能更好的提升运算的效率。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/6/0/60cbc1c86d0c2600261dc810515e29c666d3efc1.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/60cbc1c86d0c2600261dc810515e29c666d3efc1_2_690x324-k3zuZpB7.jpeg" alt="sort" loading="lazy">sort1814×852 135 KB</a></p><h2 id="其他优化" tabindex="-1"><a class="header-anchor" href="#其他优化"><span>其他优化</span></a></h2><h3 id="「阅后即焚」" tabindex="-1"><a class="header-anchor" href="#「阅后即焚」"><span>「阅后即焚」</span></a></h3><p>游戏中存在一些低频显示的大图，例如进入游戏时的公告、抽到的卡片等，玩家在游戏中看一遍就不会再出现了，对于这一类我们用了“阅后即焚”的思路。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/0/5/05516a09041b5d5a5f7f4d37e0eac2b19e87485a.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/05516a09041b5d5a5f7f4d37e0eac2b19e87485a_2_690x370-ZNhDnGOB.jpeg" alt="image" loading="lazy">image1197×642 358 KB</a></p><p>像这些大图，我们通常先从远程服务器下载到本地缓存，产生 <strong>Image</strong> 对象，还有 <strong>cc.Texture2D、renderer.Texture2D</strong>。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/0/d/0d4d0b2867a7aa66add303b9f3d14bf5b0ef34d0.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/0d4d0b2867a7aa66add303b9f3d14bf5b0ef34d0_2_690x309-CvoovyQN.jpeg" alt="download" loading="lazy">download1145×513 55.7 KB</a></p><p>我们通过伪代码来简单讲解一下，加载图片时，将图片添加到我们自己创建的回收用工具类 TextureRecycle 中。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/6/4/64a6e7d3273f82fe5e4846aa5b92951c1cf55b0a.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/64a6e7d3273f82fe5e4846aa5b92951c1cf55b0a-BQa3HYGD.jpeg" alt="destoryTs" loading="lazy">destoryTs962×246 50.7 KB</a></p><p>视图关闭时，通过工具类回收这些图片。</p><figure><img src="/assets/ee430a75c31f12cb82d47a95f8f129816c07c050-CIN3L8UD.png" alt="cleanUp" tabindex="0" loading="lazy"><figcaption>cleanUp</figcaption></figure><p>在图片的回收阶段中，就可以将以上所有用到的对象都清理干净了。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/8/1/81a0be4e054d69873793209af73cc4770755d693.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/81a0be4e054d69873793209af73cc4770755d693-BLi4T6Ib.jpeg" alt="cache" loading="lazy">cache871×423 79.5 KB</a></p><h3 id="构建优化" tabindex="-1"><a class="header-anchor" href="#构建优化"><span>构建优化</span></a></h3><p>在构建发布流程中，江南百景图项目使用了大量的自动化脚本来优化构建流程。包括 <strong>全平台构建、上传游戏平台、资源预处理和后处理、CDN 同步和版本控制和二次混淆加密</strong> 等。但成也脚本败也脚本，过长的构建时间也造成了不少困扰，因此我们也需要做一些额外优化。</p><p>Cocos 新版本添加了一个第三方开源压缩工具 <strong>Sharp</strong>，压缩级别是 0-9，数值越大压缩越久，而 Cocos 的默认参数是 <strong>6</strong>。由于我们已经进行过 <strong>图片减色</strong> 处理，因此我们将参数改为 <strong>0</strong>，这样就能减少很多构建的时间。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/a/1/a13f0931b92fb8e9532426c3eb7d8dd374d3c460.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/a13f0931b92fb8e9532426c3eb7d8dd374d3c460_2_690x293-CMYzXUAX.jpeg" alt="buildVage" loading="lazy">buildVage1704×724 168 KB</a></p><p>而在各平台构建时，总是格外漫长，原因是每次平台构建时，Creator 都要重新生成对应的平台图集。找到原因后，我们在每次构建前，将对应目录中的 <strong>info.json</strong> 中的 <strong>actualPlatform</strong> 参数先修改为 <strong>对应的平台名称</strong> 再打包，这个改动使我们的构建时间由之前的 15 分钟缩短到 10 分钟左右，提升了 30% 效率。</p><p><a href="https://forum.cocos.org/uploads/default/original/3X/3/a/3a70c612895b461318927da0be3b2ec0ccd5483c.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/3a70c612895b461318927da0be3b2ec0ccd5483c_2_690x376-sa2kIKCC.jpeg" alt="route" loading="lazy">route1328×724 144 KB</a></p><p><a href="https://forum.cocos.org/uploads/default/original/3X/4/f/4f8d4e95ee9c113f0c88b9de17c06f0949b039b5.jpeg" target="_blank" rel="noopener noreferrer"><img src="/assets/4f8d4e95ee9c113f0c88b9de17c06f0949b039b5_2_690x292-DXEWvyzR.jpeg" alt="routeScripts" loading="lazy">routeScripts1666×706 185 KB</a></p><h2 id="结语" tabindex="-1"><a class="header-anchor" href="#结语"><span>结语</span></a></h2><p>在不懈的优化下，我们看到在现场演示时，这个用于官方演示游戏的高级账号，在游戏场景人物都很丰富的情况下，仍然只有 6 个 Draw Call。</p></div><!----><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">上次编辑于: </span><span class="vp-meta-info" data-allow-mismatch="text">2024/12/3 08:56:20</span></div><div class="contributors"><span class="vp-meta-label">贡献者: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 1150274785@qq.com">lmb0989</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/Book/%E6%B8%B8%E6%88%8F/CocosCreator/shader.html" aria-label="shader"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->shader</div></a><a class="route-link auto-link next" href="/Book/%E6%B8%B8%E6%88%8F/CocosCreator/%E5%AE%9A%E5%88%B6%E5%BC%95%E6%93%8E/" aria-label="定制引擎"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">定制引擎<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!--[--><!--]--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DJCjgs7r.js" defer></script>
  </body>
</html>
